import React from "react";
import { format } from "date-fns";
import TimeRange from "react-timeline-range-slider";
import packageJson from '../../../package.json';
import { ThemeProvider } from 'styled-components';
import EnterprisePreset, { themes as presetThemes } from '@splunk/dashboard-presets/EnterprisePreset';
import DashboardCore, { themes as dashboardCoreThemes } from '@splunk/dashboard-core';
import { themes as reactUIThemes } from '@splunk/react-ui/themes';
import definition from '../../pages/timelapse/definition.json';


const dashboard_id = window.location.pathname.split("/").pop()
const themeKey = 'enterpriseDark';

const theme = {
    ...presetThemes[themeKey],
    ...dashboardCoreThemes[themeKey],
    ...reactUIThemes[themeKey],
};

var selectedInterval = []
var disabledIntervals = []
var timelineInterval = []
var def = {}

for (let timelapse_index = 0; timelapse_index < packageJson.timesliders.length; timelapse_index++)
{
    if (packageJson.timesliders[timelapse_index].dashboard_id === dashboard_id){
    	selectedInterval = packageJson.timesliders[timelapse_index].selectedInterval

        selectedInterval.forEach(function(part, index, theArray) {
            theArray[index] = new Date(theArray[index]);
        });
        disabledIntervals = packageJson.timesliders[timelapse_index].disabledIntervals
        
        timelineInterval= packageJson.timesliders[timelapse_index].timelineInterval
        timelineInterval.forEach(function(part, index, theArray) {
            theArray[index] = new Date(theArray[index]);
        }); 
  }
}

class SplunkTimeRangeSlider extends React.Component {
  state = {
    error: false,
    selectedInterval,
    def: this.props.dash.props.definition
  };
  errorHandler = ({ error }) => this.setState({ error });
  onChangeCallback = (selectedInterval) => {

this.setState({ selectedInterval })
for(var v in this.state.def.dataSources)
{
this.state.def.dataSources[v].options.query = "| makeresults count=10 | eval t=86400 | streamstats sum(t) as t | eval t = (random() % 100000) + 1"
}

this.setState({
        def: this.state.def

}
)
};

  render() {
    const { selectedInterval, def, error } = this.state;
    return (
      <div className="container">
        <div className="info">
          <span>Selected Interval: </span>
          {selectedInterval.map((d, i) => {
	  if (i == 0){
		return <span id={i} key={i}>{format(d, "MM/dd/yyyy HH:mm")} through </span>
	  }
          if (i==1){
	      return <span id={i} key={i}>{format(d, "MM/dd/yyyy HH:mm")}</span>
	    }          
	})}
        </div>

        <TimeRange
          error={error}
          ticksNumber={36}
          selectedInterval={timelineInterval}
          timelineInterval={timelineInterval}
          onUpdateCallback={this.errorHandler}
          onChangeCallback={this.onChangeCallback}
          disabledIntervals={disabledIntervals}
        />
<p>
{JSON.stringify(this.state.def.dataSources)}
</p>
</div>

<div>
<ThemeProvider theme={theme}>

<DashboardCore
            width="100%"
            height="calc(100vh - 78px)"
            definition={this.state.def}
            preset={EnterprisePreset}
        />


</ThemeProvider>
</div>
    );
  }
}

export default SplunkTimeRangeSlider;

